{% extends "base.html" %}

{% block title %}–ñ—É—Ä–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏ –∫—É–ª—å—Ç—É—Ä - AgroPlan{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: rgba(23, 42, 69, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(100, 255, 218, 0.2);
    border-radius: var(--radius-xl);
    padding: 24px;
    text-align: center;
    transition: all 0.3s var(--ease-smooth);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(100, 255, 218, 0.1), transparent);
    transition: left 0.6s var(--ease-smooth);
}

.stat-card:hover::before {
    left: 100%;
}

.stat-card:hover {
    border-color: rgba(100, 255, 218, 0.4);
    transform: translateY(-2px);
    box-shadow: var(--shadow-elegant);
}

.stat-card h3 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--emerald);
    margin: 0 0 8px 0;
    background: linear-gradient(135deg, var(--emerald), #64ffda);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-card p {
    color: var(--light-slate);
    margin: 0;
    font-size: 0.9rem;
    font-weight: 500;
}

.filters-container {
    background: rgba(23, 42, 69, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(100, 255, 218, 0.2);
    border-radius: var(--radius-xl);
    padding: 24px;
    margin: 20px 0;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
}

.filter-group label {
    color: var(--emerald);
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    white-space: nowrap;
}

.filter-select {
    background: rgba(23, 42, 69, 0.6);
    border: 1px solid rgba(100, 255, 218, 0.1);
    border-radius: var(--radius-lg);
    color: var(--white);
    padding: 12px 16px;
    font-size: 0.9rem;
    min-width: 150px;
    transition: all 0.3s var(--ease-smooth);
    backdrop-filter: blur(10px);
}

.filter-select:focus {
    outline: none;
    border-color: rgba(100, 255, 218, 0.4);
    box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.1);
}

.history-table {
    background: rgba(23, 42, 69, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(100, 255, 218, 0.2);
    border-radius: var(--radius-xl);
    overflow: hidden;
    margin: 20px 0;
}

.history-table table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
}

.history-table th {
    background: rgba(100, 255, 218, 0.1);
    color: var(--emerald);
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 16px 12px;
    text-align: left;
    border-bottom: 1px solid rgba(100, 255, 218, 0.2);
}

.history-table td {
    padding: 16px 12px;
    border-bottom: 1px solid rgba(100, 255, 218, 0.1);
    color: var(--light-slate);
    transition: all 0.3s var(--ease-smooth);
}

.history-table tr:hover td {
    background: rgba(100, 255, 218, 0.05);
    color: var(--white);
}

.history-table tr:last-child td {
    border-bottom: none;
}

.season-badge {
    padding: 6px 12px;
    border-radius: var(--radius-full);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.season-–≤–µ—Å–Ω–∞ {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    border: 1px solid rgba(76, 175, 80, 0.3);
}

.season-–ª–µ—Ç–æ {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.season-–æ—Å–µ–Ω—å {
    background: rgba(121, 85, 72, 0.2);
    color: #795548;
    border: 1px solid rgba(121, 85, 72, 0.3);
}

.action-buttons {
    display: flex;
    gap: 8px;
    opacity: 0.7;
    transition: opacity 0.3s var(--ease-smooth);
}

.history-table tr:hover .action-buttons {
    opacity: 1;
}

.action-btn {
    background: none;
    border: none;
    color: var(--light-slate);
    cursor: pointer;
    padding: 6px;
    border-radius: var(--radius-md);
    transition: all 0.3s var(--ease-smooth);
    font-size: 1rem;
}

.action-btn:hover {
    background: rgba(100, 255, 218, 0.1);
    color: var(--emerald);
    transform: scale(1.1);
}

.action-btn.delete:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.empty-state {
    text-align: center;
    padding: 80px 40px;
    color: var(--light-slate);
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.7;
}

.empty-state h3 {
    color: var(--light-slate);
    margin-bottom: 12px;
}

.empty-state p {
    margin-bottom: 24px;
    font-size: 1.1rem;
}

.btn-group {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .filter-group {
        flex-direction: column;
        align-items: stretch;
    }

    .filter-select {
        min-width: auto;
    }

    .history-table {
        overflow-x: auto;
    }

    .history-table table {
        min-width: 800px;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
.stats-grid, .filters-container, .history-table {
    animation: slideUp 0.6s var(--ease-smooth);
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>üìä –ñ—É—Ä–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏ –∫—É–ª—å—Ç—É—Ä</h2>
        <div class="header-icon">üå±</div>
    </div>
    <p>–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å–∞–¥–æ–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏</p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-grid">
    <div class="stat-card">
        <h3>{{ history|length }}</h3>
        <p>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
    </div>
    <div class="stat-card">
        <h3>{{ (history|map(attribute='field_area')|sum)|round(1) if history else 0 }}</h3>
        <p>–ì–µ–∫—Ç–∞—Ä–æ–≤ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ</p>
    </div>
    <div class="stat-card">
        <h3>{{ (history|map(attribute='year')|unique|list)|length if history else 0 }}</h3>
        <p>–õ–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏</p>
    </div>
    <div class="stat-card">
        <h3>{{ (history|map(attribute='crop')|unique|list)|length if history else 0 }}</h3>
        <p>–†–∞–∑–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä</p>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters-container">
    <div class="filter-group">
        <label for="yearFilter">–§–∏–ª—å—Ç—Ä –ø–æ –≥–æ–¥—É:</label>
        <select id="yearFilter" class="filter-select" onchange="filterByYear(this.value)">
            <option value="">–í—Å–µ –≥–æ–¥—ã</option>
            {% for year in years %}
            <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>

        <button onclick="clearFilters()" class="btn btn-secondary btn-icon">
            <span class="btn-icon">üîÑ</span>
            –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        </button>
        <button onclick="exportToCSV()" class="btn btn-primary btn-icon">
            <span class="btn-icon">üì•</span>
            –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        </button>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
<div class="history-table">
    <table>
        <thead>
            <tr>
                <th>–ì–æ–¥</th>
                <th>–°–µ–∑–æ–Ω</th>
                <th>–ü–æ–ª–µ</th>
                <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                <th>–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å</th>
                <th>–ó–∞–º–µ—Ç–∫–∏</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for record in history %}
            <tr>
                <td><strong>{{ record.year }}</strong></td>
                <td>
                    {% if record.season %}
                    <span class="season-badge season-{{ record.season }}">
                        {{ record.season }}
                    </span>
                    {% else %}
                    <span style="color: var(--light-slate);">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/fields/{{ record.field_id }}" style="color: var(--emerald); text-decoration: none; font-weight: 500;">
                        {{ record.field_name }}
                    </a>
                </td>
                <td>{{ record.crop }}</td>
                <td>
                    {% if record.yield_amount %}
                    <strong style="color: var(--white);">{{ "%.1f"|format(record.yield_amount) }}</strong> —Ç/–≥–∞
                    {% else %}
                    <span style="color: var(--light-slate);">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if record.notes %}
                    <span title="{{ record.notes }}" style="cursor: help;">üìù</span>
                    {% else %}
                    <span style="color: var(--light-slate);">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <a href="/history/edit/{{ record.id }}" class="action-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </a>
                        <a href="/history/delete/{{ record.id }}" class="action-btn delete" title="–£–¥–∞–ª–∏—Ç—å"
                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ {{ record.year }} –≥–æ–¥?')">
                            üóëÔ∏è
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if not history %}
<div class="card empty-state">
    <div class="empty-state-icon">üìù</div>
    <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–∞–¥–æ–∫ –ø—É—Å—Ç–∞</h3>
    <p>–ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞–ø–∏—Å–∏ –æ –ø–æ—Å–∞–¥–∫–∞—Ö –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –ø–æ–ª–µ–π</p>
    <div class="btn-group">
        <a href="/fields" class="btn btn-primary btn-icon">
            <span class="btn-icon">üìã</span>
            –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–ª—è–º
        </a>
        <a href="/fields" class="btn btn-secondary">
            –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ
        </a>
    </div>
</div>
{% endif %}

<script>
function filterByYear(year) {
    if (year) {
        window.location.href = `/history?year=${year}`;
    } else {
        window.location.href = '/history';
    }
}

function clearFilters() {
    window.location.href = '/history';
}

function exportToCSV() {
    let csv = '–ì–æ–¥,–°–µ–∑–æ–Ω,–ü–æ–ª–µ,–ö—É–ª—å—Ç—É—Ä–∞,–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å,–ó–∞–º–µ—Ç–∫–∏\n';

    {% for record in history %}
    csv += `{{ record.year }},{{ record.season or '' }},{{ record.field_name }},{{ record.crop }},{{ record.yield_amount or '' }},"{{ record.notes or '' }}"\n`;
    {% endfor %}

    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `–∏—Å—Ç–æ—Ä–∏—è_–ø–æ—Å–∞–¥–æ–∫_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —ç–∫—Å–ø–æ—Ä—Ç–µ
    showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
}

function showNotification(message, type = 'info') {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 'rgba(23, 42, 69, 0.9)'};
        color: white;
        padding: 16px 24px;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(100, 255, 218, 0.3);
        backdrop-filter: blur(10px);
        z-index: 1000;
        animation: slideInRight 0.3s var(--ease-smooth);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s var(--ease-smooth)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>

<style>
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
{% endblock %}