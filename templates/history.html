{% extends "base.html" %}

{% block title %}–ñ—É—Ä–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏ –∫—É–ª—å—Ç—É—Ä - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–µ–≤–æ–æ–±–æ—Ä–æ—Ç–∞{% endblock %}

{% block content %}
<div class="card">
    <h2>üìä –ñ—É—Ä–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏ –∫—É–ª—å—Ç—É—Ä</h2>
    <p>–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å–∞–¥–æ–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.</p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-cards">
    <div class="stat-card">
        <h3>{{ history|length }}</h3>
        <p>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
    </div>
    <div class="stat-card">
        <h3>{{ (history|map(attribute='field_area')|sum)|round(1) if history else 0 }}</h3>
        <p>–ì–µ–∫—Ç–∞—Ä–æ–≤ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ</p>
    </div>
    <div class="stat-card">
        <h3>{{ (history|map(attribute='year')|unique|list)|length if history else 0 }}</h3>
        <p>–õ–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏</p>
    </div>
    <div class="stat-card">
        <h3>{{ (history|map(attribute='crop')|unique|list)|length if history else 0 }}</h3>
        <p>–†–∞–∑–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä</p>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters">
    <div class="filter-group">
        <label for="yearFilter">–§–∏–ª—å—Ç—Ä –ø–æ –≥–æ–¥—É:</label>
        <select id="yearFilter" onchange="filterByYear(this.value)">
            <option value="">–í—Å–µ –≥–æ–¥—ã</option>
            {% for year in years %}
            <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
        </select>
        
        <button onclick="clearFilters()" class="btn-secondary">‚ùå –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        <button onclick="exportToCSV()" class="btn">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
<div class="history-table">
    <table>
        <thead>
            <tr>
                <th>–ì–æ–¥</th>
                <th>–°–µ–∑–æ–Ω</th>
                <th>–ü–æ–ª–µ</th>
                <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                <th>–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å</th>
                <th>–ó–∞–º–µ—Ç–∫–∏</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for record in history %}
            <tr>
                <td><strong>{{ record.year }}</strong></td>
                <td>
                    {% if record.season %}
                    <span class="season-badge season-{{ record.season }}">
                        {{ record.season }}
                    </span>
                    {% else %}
                    <span style="color: var(--text-light);">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/fields/{{ record.field_id }}" style="color: var(--primary); text-decoration: none;">
                        {{ record.field_name }}
                    </a>
                </td>
                <td>{{ record.crop }}</td>
                <td>
                    {% if record.yield_amount %}
                    <strong>{{ "%.1f"|format(record.yield_amount) }}</strong> —Ç/–≥–∞
                    {% else %}
                    <span style="color: var(--text-light);">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if record.notes %}
                    <span title="{{ record.notes }}">üìù</span>
                    {% else %}
                    <span style="color: var(--text-light);">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 10px;">
                        <a href="/history/edit/{{ record.id }}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" style="color: var(--primary);">
                            ‚úèÔ∏è
                        </a>
                        <a href="/history/delete/{{ record.id }}" title="–£–¥–∞–ª–∏—Ç—å" style="color: var(--danger);"
                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ {{ record.year }} –≥–æ–¥?')">
                            üóëÔ∏è
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if not history %}
<div class="card" style="text-align: center; padding: 60px 20px;">
    <div style="font-size: 4rem; margin-bottom: 20px;">üìù</div>
    <h3 style="color: var(--text-light);">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–∞–¥–æ–∫ –ø—É—Å—Ç–∞</h3>
    <p style="color: var(--text-light);">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ–ª—è</p>
    <a href="/fields" class="btn" style="margin-top: 20px;">üìã –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–ª—è–º</a>
</div>
{% endif %}

<script>
function filterByYear(year) {
    if (year) {
        window.location.href = `/history?year=${year}`;
    } else {
        window.location.href = '/history';
    }
}

function clearFilters() {
    window.location.href = '/history';
}

function exportToCSV() {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ CSV
    let csv = '–ì–æ–¥,–°–µ–∑–æ–Ω,–ü–æ–ª–µ,–ö—É–ª—å—Ç—É—Ä–∞,–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å,–ó–∞–º–µ—Ç–∫–∏\n';

    {% for record in history %}
    csv += `{{ record.year }},{{ record.season or '' }},{{ record.field_name }},{{ record.crop }},{{ record.yield_amount or '' }},{{ record.notes or '' }}\n`;
    {% endfor %}
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '–∏—Å—Ç–æ—Ä–∏—è_–ø–æ—Å–∞–¥–æ–∫.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
