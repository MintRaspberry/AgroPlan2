{% extends "base.html" %}

{% block title %}{{ field.name }} - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–µ–≤–æ–æ–±–æ—Ä–æ—Ç–∞{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: between; align-items: center;">
        <h2>üëÅÔ∏è –ü–æ–ª–µ: {{ field.name }}</h2>
        <a href="/fields" class="btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–µ -->
    <div class="card">
        <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–µ</h3>
        <div class="field-info">
            <div>
                <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong><br>{{ field.name }}</p>
                <p><strong>–ü–ª–æ—â–∞–¥—å:</strong><br>{{ "%.2f"|format(field.area) if field.area else '0' }} –≥–∞</p>
            </div>
            <div>
                <p><strong>ID –ø–æ–ª—è:</strong><br>#{{ field.id }}</p>
                <p><strong>–î–æ–±–∞–≤–ª–µ–Ω–æ:</strong><br>{{ field.created_at[:10] }}</p>
            </div>
        </div>

        {% if field.latitude and field.longitude %}
        <div style="margin-top: 15px;">
            <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞:</strong></p>
            <p>–®–∏—Ä–æ—Ç–∞: {{ field.latitude }}, –î–æ–ª–≥–æ—Ç–∞: {{ field.longitude }}</p>
        </div>
        {% endif %}

        {% if polygon_data %}
        <div style="margin-top: 15px;">
            <p><strong>–ì—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—è:</strong> –∑–∞–¥–∞–Ω—ã ({{ polygon_data|length }} —Ç–æ—á–µ–∫)</p>
        </div>
        {% endif %}
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div class="card">
        <h3>üìù –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é</h3>
        <form method="post" action="/fields/{{ field.id }}/history">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div>
                    <label for="year">–ì–æ–¥:</label>
                    <input type="number" id="year" name="year" min="2000" max="2030" value="2024" required>
                </div>
                <div>
                    <label for="season">–°–µ–∑–æ–Ω:</label>
                    <select id="season" name="season" required>
                        <option value="–≤–µ—Å–Ω–∞">–í–µ—Å–Ω–∞</option>
                        <option value="–ª–µ—Ç–æ">–õ–µ—Ç–æ</option>
                        <option value="–æ—Å–µ–Ω—å">–û—Å–µ–Ω—å</option>
                    </select>
                </div>
                <div>
                    <label for="crop">–ö—É–ª—å—Ç—É—Ä–∞:</label>
                    <input type="text" id="crop" name="crop" required list="crops" placeholder="–ü—à–µ–Ω–∏—Ü–∞">
                    <datalist id="crops">
                        <option value="–ø—à–µ–Ω–∏—Ü–∞">
                        <option value="–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å">
                        <option value="–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–∏–∫">
                        <option value="–≥–æ—Ä–æ—Ö">
                        <option value="—è—á–º–µ–Ω—å">
                        <option value="–∫—É–∫—É—Ä—É–∑–∞">
                        <option value="–æ–≤—ë—Å">
                        <option value="—Å–æ—è">
                        <option value="—Ä–æ–∂—å">
                        <option value="–≥—Ä–µ—á–∏—Ö–∞">
                        <option value="–ª–µ–Ω">
                    </datalist>
                </div>
                <div>
                    <label for="yield_amount">–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å (—Ç/–≥–∞):</label>
                    <input type="number" id="yield_amount" name="yield_amount" step="0.1" min="0" placeholder="3.5">
                </div>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label for="notes">–ó–∞–º–µ—Ç–∫–∏:</label>
                <textarea id="notes" name="notes" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å–∞–¥–∫–µ..."></textarea>
            </div>

            <button type="submit" style="margin-top: 15px; width: 100%;">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        </form>
    </div>
</div>

<!-- –ö–∞—Ä—Ç–∞ –ø–æ–ª—è -->
{% if polygon_data %}
<div class="card">
    <h3>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –ø–æ–ª—è</h3>
    <div class="map-container">
        <div id="fieldMap" class="field-map"></div>
    </div>
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—è
    document.addEventListener('DOMContentLoaded', function() {
        const polygonData = {{ polygon_data | tojson }};
        initViewMap(polygonData, "{{ field.name }}", "{{ field.area }}");
    });
</script>
{% endif %}

<!-- –ì—Ä–∞—Ñ–∏–∫ —Å–µ–≤–æ–æ–±–æ—Ä–æ—Ç–∞ -->
{% if rotation_history and rotation_history|length > 1 %}
<div class="chart-container">
    <h3>üìà –ò—Å—Ç–æ—Ä–∏—è —Å–µ–≤–æ–æ–±–æ—Ä–æ—Ç–∞</h3>
    <canvas id="rotationChart" height="200"></canvas>
    <script>
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω—ã –≤ Python
        const rotationData = {{ rotation_history | tojson }};

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –∫–æ–≥–¥–∞ DOM –∑–∞–≥—Ä—É–∂–µ–Ω
        document.addEventListener('DOMContentLoaded', function() {
            initRotationTimeline(rotationData);
        });
    </script>
</div>
{% elif rotation_history %}
<div class="chart-container">
    <h3>üìà –ò—Å—Ç–æ—Ä–∏—è —Å–µ–≤–æ–æ–±–æ—Ä–æ—Ç–∞</h3>
    <div class="chart-placeholder">
        <p>üìä –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å–µ–≤–æ–æ–±–æ—Ä–æ—Ç–∞</p>
    </div>
</div>
{% endif %}

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ -->
{% if yield_stats %}
<div class="chart-container">
    <h3>üìä –£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å –ø–æ –∫—É–ª—å—Ç—É—Ä–∞–º</h3>
    <canvas id="yieldChart" height="300"></canvas>
    <script>
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—è
        document.addEventListener('DOMContentLoaded', function() {
            loadYieldStats({{ field.id }});
        });
    </script>
</div>
{% endif %}

<!-- –ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
{% if climate_analysis %}
<div class="card">
    <h3>üå§Ô∏è –ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        {% if climate_analysis.current_weather %}
        <div class="weather-info">
            <h4>–¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞</h4>
            <p><strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</strong> {{ "%.1f"|format(climate_analysis.current_weather.temperature) }}¬∞C</p>
            <p><strong>–í–ª–∞–∂–Ω–æ—Å—Ç—å:</strong> {{ climate_analysis.current_weather.humidity }}%</p>
            <p><strong>–û—Å–∞–¥–∫–∏:</strong> {{ "%.1f"|format(climate_analysis.current_weather.precipitation) }} –º–º</p>
        </div>
        {% endif %}

        {% if climate_analysis.forecast_summary %}
        <div class="forecast-info">
            <h4>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ {{ climate_analysis.forecast_summary.forecast_days }} –¥–Ω–µ–π</h4>
            <p><strong>–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</strong> {{ "%.1f"|format(climate_analysis.forecast_summary.avg_temperature) }}¬∞C</p>
            <p><strong>–û—Å–∞–¥–∫–∏:</strong> {{ "%.1f"|format(climate_analysis.forecast_summary.total_precipitation) }} –º–º</p>
        </div>
        {% endif %}

        {% if climate_analysis.growing_season_info %}
        <div class="season-info">
            <h4>–í–µ–≥–µ—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</h4>
            <p><strong>–ù–∞—á–∞–ª–æ:</strong> {{ climate_analysis.growing_season_info.start }}</p>
            <p><strong>–ö–æ–Ω–µ—Ü:</strong> {{ climate_analysis.growing_season_info.end }}</p>
            <p><strong>–î–Ω–µ–π:</strong> {{ climate_analysis.growing_season_info.days }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- –ü—Ä–æ–≥–Ω–æ–∑ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏ -->
{% if yield_prediction %}
<div class="card" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);">
    <h3>üìà –ü—Ä–æ–≥–Ω–æ–∑ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏</h3>
    <div style="text-align: center; padding: 20px;">
        <div style="font-size: 2.5rem; font-weight: bold; color: #1976d2;">
            {{ "%.1f"|format(yield_prediction) }} —Ç/–≥–∞
        </div>
        <p style="color: #666; margin-top: 10px;">–û–∂–∏–¥–∞–µ–º–∞—è —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏–π</p>
    </div>
</div>
{% endif %}

<!-- –ò—Å—Ç–æ—Ä–∏—è –∫—É–ª—å—Ç—É—Ä -->
<div class="card">
    <h3>üìã –ò—Å—Ç–æ—Ä–∏—è –∫—É–ª—å—Ç—É—Ä</h3>

    {% if history %}
    <div class="history-table">
        <table>
            <thead>
                <tr>
                    <th>–ì–æ–¥</th>
                    <th>–°–µ–∑–æ–Ω</th>
                    <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                    <th>–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å</th>
                    <th>–ó–∞–º–µ—Ç–∫–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for record in history %}
                <tr>
                    <td><strong>{{ record.year }}</strong></td>
                    <td>
                        <span class="season-badge season-{{ record.season }}">
                            {{ record.season }}
                        </span>
                    </td>
                    <td>{{ record.crop }}</td>
                    <td>
                        {% if record.yield_amount %}
                        <strong>{{ "%.1f"|format(record.yield_amount) }}</strong> —Ç/–≥–∞
                        {% else %}
                        <span style="color: var(--text-light);">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if record.notes %}
                        <span title="{{ record.notes }}">üìù</span>
                        {% else %}
                        <span style="color: var(--text-light);">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 10px;">
                            <a href="/history/edit/{{ record.id }}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" style="color: var(--primary);">
                                ‚úèÔ∏è
                            </a>
                            <a href="/history/delete/{{ record.id }}" title="–£–¥–∞–ª–∏—Ç—å" style="color: var(--danger);"
                               onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ {{ record.year }} –≥–æ–¥?')">
                                üóëÔ∏è
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: var(--text-light);">
        <div style="font-size: 3rem; margin-bottom: 15px;">üìù</div>
        <p>–î–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏.</p>
        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
