{% extends "base.html" %}

{% block title %}–í—ã–±–æ—Ä –ø–æ–ª—è –Ω–∞ –∫–∞—Ä—Ç–µ –†–æ—Å—Å–∏–∏ - AgroPlan{% endblock %}

{% block extra_css %}
<style>
.map-container {
    height: 600px;
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-medium);
    margin: 20px 0;
}

.field-selection-panel {
    background: rgba(23, 42, 69, 0.8);
    border: 1px solid rgba(100, 255, 218, 0.2);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 20px;
}

.selected-field-info {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: var(--radius-lg);
    padding: 15px;
    margin-top: 15px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.map-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.instruction-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 20px;
}

.instruction-step {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
}

.step-number {
    background: var(--gradient-emerald);
    color: var(--deep-navy);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 700;
    flex-shrink: 0;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--gradient-emerald);
    color: var(--deep-navy);
    padding: 16px 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-large);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideInRight 0.3s ease-out;
}

.notification-error {
    background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
    color: white;
}

.notification button {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.field-marker {
    background: transparent !important;
    border: none !important;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è Leaflet */
.leaflet-container {
    font-family: 'Inter', sans-serif;
    background: var(--dark-slate);
}

.leaflet-popup-content {
    margin: 8px 12px;
    font-family: 'Inter', sans-serif;
}
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üó∫Ô∏è –í—ã–±–æ—Ä –ø–æ–ª—è –Ω–∞ –∫–∞—Ä—Ç–µ –†–æ—Å—Å–∏–∏</h2>
        <a href="/history" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –∏—Å—Ç–æ—Ä–∏–∏</a>
    </div>
</div>

<div class="instruction-card">
    <h3>üìã –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å –ø–æ–ª–µ:</h3>
    <div class="instruction-step">
        <div class="step-number">1</div>
        <div>–ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ –ø–æ–ª–µ –Ω–∞ –∫–∞—Ä—Ç–µ –†–æ—Å—Å–∏–∏ –Ω–∏–∂–µ</div>
    </div>
    <div class="instruction-step">
        <div class="step-number">2</div>
        <div>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
    </div>
    <div class="instruction-step">
        <div class="step-number">3</div>
        <div>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–∞–¥–∫–µ</div>
    </div>
</div>

<div class="field-selection-panel">
    <h4>üìç –ö–∞—Ä—Ç–∞ —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π –†–æ—Å—Å–∏–∏</h4>

    <div class="map-controls">
        <button type="button" id="resetViewBtn" class="btn btn-secondary">üó∫Ô∏è –í–µ—Å—å –≤–∏–¥ –†–æ—Å—Å–∏–∏</button>
        <button type="button" id="findFieldsBtn" class="btn btn-secondary">üîç –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–æ–ª—è</button>
    </div>

    <div class="map-container">
        <div id="russiaMap"></div>
    </div>

    <div id="selectedFieldInfo" class="selected-field-info" style="display: none;">
        <h5>‚úÖ –í—ã–±—Ä–∞–Ω–æ –ø–æ–ª–µ:</h5>
        <div id="fieldDetails">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–æ–ª–µ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
    </div>
</div>

<form method="post" action="/history/add" id="historyForm">
    <input type="hidden" id="selectedFieldId" name="field_id" required>

    <div class="card">
        <h3>üìù –î–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–∞–¥–∫–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—è</h3>

        <div class="form-grid">
            <div class="form-group">
                <label for="year" class="form-label">–ì–æ–¥</label>
                <input type="number" id="year" name="year" min="2000" max="2030"
                       value="{{ now().year }}" class="form-input" required>
            </div>

            <div class="form-group">
                <label for="season" class="form-label">–°–µ–∑–æ–Ω</label>
                <select id="season" name="season" class="form-select" required>
                    <option value="–≤–µ—Å–Ω–∞">–í–µ—Å–Ω–∞</option>
                    <option value="–ª–µ—Ç–æ">–õ–µ—Ç–æ</option>
                    <option value="–æ—Å–µ–Ω—å">–û—Å–µ–Ω—å</option>
                </select>
            </div>

            <div class="form-group">
                <label for="crop" class="form-label">–ö—É–ª—å—Ç—É—Ä–∞</label>
                <select id="crop" name="crop" class="form-select" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—É–ª—å—Ç—É—Ä—É --</option>
                    <option value="–ø—à–µ–Ω–∏—Ü–∞">–ü—à–µ–Ω–∏—Ü–∞</option>
                    <option value="—è—á–º–µ–Ω—å">–Ø—á–º–µ–Ω—å</option>
                    <option value="–æ–≤—ë—Å">–û–≤—ë—Å</option>
                    <option value="—Ä–æ–∂—å">–†–æ–∂—å</option>
                    <option value="–∫—É–∫—É—Ä—É–∑–∞">–ö—É–∫—É—Ä—É–∑–∞</option>
                    <option value="–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–∏–∫">–ü–æ–¥—Å–æ–ª–Ω–µ—á–Ω–∏–∫</option>
                    <option value="—Å–æ—è">–°–æ—è</option>
                    <option value="—Ä–∞–ø—Å">–†–∞–ø—Å</option>
                    <option value="–≥—Ä–µ—á–∏—Ö–∞">–ì—Ä–µ—á–∏—Ö–∞</option>
                    <option value="–ª—ë–Ω">–õ—ë–Ω</option>
                    <option value="–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å">–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å</option>
                    <option value="—Å–≤—ë–∫–ª–∞">–°–≤—ë–∫–ª–∞</option>
                    <option value="–≥–æ—Ä–æ—Ö">–ì–æ—Ä–æ—Ö</option>
                </select>
            </div>

            <div class="form-group">
                <label for="yield_amount" class="form-label">–£—Ä–æ–∂–∞–π–Ω–æ—Å—Ç—å (—Ç/–≥–∞)</label>
                <input type="number" id="yield_amount" name="yield_amount"
                       step="0.1" min="0" class="form-input" placeholder="3.5">
            </div>
        </div>

        <div class="form-group">
            <label for="notes" class="form-label">–ó–∞–º–µ—Ç–∫–∏</label>
            <textarea id="notes" name="notes" rows="3" class="form-input"
                      placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å–∞–¥–∫–µ..."></textarea>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary btn-large" disabled>
            ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏
        </button>

        <div id="formWarning" class="card" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3); margin-top: 15px; display: none;">
            <p style="color: var(--gold); margin: 0;">
                ‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª–µ –Ω–∞ –∫–∞—Ä—Ç–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
            </p>
        </div>
    </div>
</form>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç—ã
let russiaMap;
let fieldLayers = {};
let selectedFieldId = null;

// –ì—Ä–∞–Ω–∏—Ü—ã –†–æ—Å—Å–∏–∏ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
const russiaBounds = L.latLngBounds(
    [41.185, 19.638], // –Æ–≥–æ-–∑–∞–ø–∞–¥
    [81.858, 180.0] // –°–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫
);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –†–æ—Å—Å–∏–∏
function initRussiaMap() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –†–æ—Å—Å–∏–∏...');

    try {
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –µ–≤—Ä–æ–ø–µ–π—Å–∫–æ–π —á–∞—Å—Ç–∏ –†–æ—Å—Å–∏–∏
        russiaMap = L.map('russiaMap', {
            minZoom: 3,
            maxBounds: russiaBounds,
            maxBoundsViscosity: 1.0
        }).setView([55.7558, 37.6173], 4);

        // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π —Å–ª–æ–π OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 13,
            minZoom: 3
        }).addTo(russiaMap);

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–µ–π –†–æ—Å—Å–∏–∏
        russiaMap.setMaxBounds(russiaBounds);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—è
        loadFieldsOnRussiaMap();

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å –º–∞—Å—à—Ç–∞–±–∞
        L.control.scale({ imperial: false, metric: true }).addTo(russiaMap);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('resetViewBtn').addEventListener('click', function() {
            russiaMap.setView([55.7558, 37.6173], 4);
        });

        document.getElementById('findFieldsBtn').addEventListener('click', function() {
            focusOnFields();
        });

        console.log('–ö–∞—Ä—Ç–∞ –†–æ—Å—Å–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –†–æ—Å—Å–∏–∏:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã', 'error');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–µ–π –Ω–∞ –∫–∞—Ä—Ç—É –†–æ—Å—Å–∏–∏
function loadFieldsOnRussiaMap() {
    fetch('/api/fields/overview')
    .then(response => response.json())
    .then(fields => {
        console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${fields.length} –ø–æ–ª–µ–π`);

        if (fields.length === 0) {
            showNotification('–ù–µ—Ç –ø–æ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—è.', 'info');
            return;
        }

        fields.forEach(field => {
            if (field.polygon_coords) {
                try {
                    const polygonData = JSON.parse(field.polygon_coords);

                    // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏–≥–æ–Ω –¥–ª—è –ø–æ–ª—è
                    const polygon = L.polygon(polygonData, {
                        color: '#10b981',
                        fillColor: '#10b981',
                        fillOpacity: 0.4,
                        weight: 2
                    }).addTo(russiaMap);

                    // –°–æ–∑–¥–∞–µ–º –ø–æ–ø–∞–ø —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                    const popupContent = `
                        <div style="text-align: center; min-width: 200px;">
                            <h4 style="margin: 0 0 10px 0; color: #065f46;">${field.name}</h4>
                            <div style="text-align: left;">
                                <p style="margin: 5px 0;"><strong>–ü–ª–æ—â–∞–¥—å:</strong> ${field.area || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'} –≥–∞</p>
                                <p style="margin: 5px 0;"><strong>ID –ø–æ–ª—è:</strong> #${field.id}</p>
                                <p style="margin: 5px 0;"><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${field.latitude ? field.latitude.toFixed(4) : 'N/A'}, ${field.longitude ? field.longitude.toFixed(4) : 'N/A'}</p>
                            </div>
                            <button onclick="selectFieldOnMap(${field.id})"
                            style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px; width: 100%;">
                                ‚úÖ –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ –ø–æ–ª–µ
                            </button>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –ø–æ–ª–∏–≥–æ–Ω
                    polygon.on('click', function(e) {
                        selectFieldOnMap(field.id);
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –ø—Ä–∏ –∫–ª–∏–∫–µ
                        polygon.openPopup();
                    });

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ª–æ–π –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    fieldLayers[field.id] = polygon;

                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ–ª–∏–≥–æ–Ω–∞ –¥–ª—è –ø–æ–ª—è', field.id, e);
                }
            } else if (field.latitude && field.longitude) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª–∏–≥–æ–Ω–∞, –Ω–æ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                const marker = L.marker([field.latitude, field.longitude], {
                    icon: L.divIcon({
                        className: 'field-marker',
                        html: 'üìç',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(russiaMap);

                const popupContent = `
                    <div style="text-align: center; min-width: 200px;">
                        <h4 style="margin: 0 0 10px 0; color: #065f46;">${field.name}</h4>
                        <div style="text-align: left;">
                            <p style="margin: 5px 0;"><strong>–ü–ª–æ—â–∞–¥—å:</strong> ${field.area || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'} –≥–∞</p>
                            <p style="margin: 5px 0;"><strong>ID –ø–æ–ª—è:</strong> #${field.id}</p>
                        </div>
                        <button onclick="selectFieldOnMap(${field.id})"
                        style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px; width: 100%;">
                            ‚úÖ –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ –ø–æ–ª–µ
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä
                marker.on('click', function(e) {
                    selectFieldOnMap(field.id);
                    marker.openPopup();
                });

                fieldLayers[field.id] = marker;
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª—è—Ö –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        if (fields.length > 0) {
            setTimeout(focusOnFields, 1000);
        }

    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–µ–π:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π', 'error');
    });
}

// –§–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞ –≤—Å–µ—Ö –ø–æ–ª—è—Ö
function focusOnFields() {
    const fieldBounds = L.latLngBounds();

    Object.values(fieldLayers).forEach(layer => {
        if (layer.getBounds) {
            fieldBounds.extend(layer.getBounds());
        } else if (layer.getLatLng) {
            fieldBounds.extend(layer.getLatLng());
        }
    });

    if (!fieldBounds.isValid()) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª–µ–π —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é –†–æ—Å—Å–∏—é
        russiaMap.setView([55.7558, 37.6173], 4);
        showNotification('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—Ä—Ç—É –†–æ—Å—Å–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—è', 'info');
        return;
    }

    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º bounds –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–±–∑–æ—Ä–∞
    const paddedBounds = fieldBounds.pad(0.1);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –†–æ—Å—Å–∏–∏
    const limitedBounds = russiaBounds.intersects(paddedBounds) ?
        paddedBounds : russiaBounds;

    russiaMap.fitBounds(limitedBounds);
}

// –í—ã–±–æ—Ä –ø–æ–ª—è –Ω–∞ –∫–∞—Ä—Ç–µ
function selectFieldOnMap(fieldId) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    if (selectedFieldId && fieldLayers[selectedFieldId]) {
        const previousLayer = fieldLayers[selectedFieldId];
        if (previousLayer.setStyle) {
            previousLayer.setStyle({
                color: '#10b981',
                fillColor: '#10b981',
                fillOpacity: 0.4,
                weight: 2
            });
        }
    }

    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª–µ
    if (fieldLayers[fieldId]) {
        const selectedLayer = fieldLayers[fieldId];
        if (selectedLayer.setStyle) {
            selectedLayer.setStyle({
                color: '#f59e0b',
                fillColor: '#f59e0b',
                fillOpacity: 0.6,
                weight: 3
            });
        }

        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–æ–ª–µ
        if (selectedLayer.getBounds) {
            russiaMap.fitBounds(selectedLayer.getBounds().pad(0.05));
        } else if (selectedLayer.getLatLng) {
            russiaMap.setView(selectedLayer.getLatLng(), 10);
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª–µ
    fetch(`/api/fields/${fieldId}/geojson`)
    .then(response => {
        if (!response.ok) throw new Error('–ü–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return response.json();
    })
    .then(fieldData => {
        const field = fieldData.features[0].properties;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–æ–ª–µ
        document.getElementById('fieldDetails').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong><br>
                    ${field.name}
                </div>
                <div>
                    <strong>–ü–ª–æ—â–∞–¥—å:</strong><br>
                    ${field.area || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'} –≥–∞
                </div>
                <div>
                    <strong>ID –ø–æ–ª—è:</strong><br>
                    #${field.id}
                </div>
                <div>
                    <strong>–î–æ–±–∞–≤–ª–µ–Ω–æ:</strong><br>
                    ${new Date(field.created_at).toLocaleDateString('ru-RU')}
                </div>
            </div>
        `;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        document.getElementById('selectedFieldInfo').style.display = 'block';

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
        document.getElementById('selectedFieldId').value = fieldId;
        selectedFieldId = fieldId;

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('formWarning').style.display = 'none';

        showNotification(`–í—ã–±—Ä–∞–Ω–æ –ø–æ–ª–µ: ${field.name}`, 'success');

    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—è:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—è', 'error');
    });
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
document.getElementById('historyForm').addEventListener('submit', function(e) {
    if (!selectedFieldId) {
        e.preventDefault();
        document.getElementById('formWarning').style.display = 'block';
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª–µ –Ω–∞ –∫–∞—Ä—Ç–µ', 'error');
    }
});

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">√ó</button>
    `;
    document.body.appendChild(notification);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—ã–±–æ—Ä–∞ –ø–æ–ª—è –Ω–∞ –∫–∞—Ä—Ç–µ –†–æ—Å—Å–∏–∏...');
    setTimeout(() => initRussiaMap(), 500);
});
</script>
{% endblock %}