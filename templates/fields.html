{% extends "base.html" %}

{% block title %}–ì–µ–æ-—É—á–µ—Ç –ø–æ–ª–µ–π - AgroPlan{% endblock %}

{% block extra_css %}
<style>
.map-container {
    height: 500px;
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-medium);
    margin: 20px 0;
}

.field-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 24px;
    margin: 32px 0;
}

.field-card {
    background: rgba(23, 42, 69, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(100, 255, 218, 0.2);
    border-radius: var(--radius-xl);
    padding: 24px;
    transition: all 0.3s var(--ease-smooth);
}

.field-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-luxury);
    border-color: rgba(100, 255, 218, 0.4);
}

.field-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.field-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--white);
    margin: 0;
}

.field-area {
    background: var(--gradient-emerald);
    color: var(--deep-navy);
    padding: 4px 12px;
    border-radius: var(--radius-full);
    font-size: 0.9rem;
    font-weight: 600;
}

.field-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
}

.field-detail {
    display: flex;
    flex-direction: column;
}

.detail-label {
    font-size: 0.8rem;
    color: var(--light-slate);
    margin-bottom: 4px;
}

.detail-value {
    font-size: 0.9rem;
    color: var(--white);
    font-weight: 500;
}

.field-actions {
    display: flex;
    gap: 8px;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--gradient-emerald);
    color: var(--deep-navy);
    padding: 16px 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-large);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideInRight 0.3s var(--ease-out);
}

.notification-error {
    background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
    color: white;
}

.notification button {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
}

.overview-map {
    height: 400px;
    border-radius: var(--radius-xl);
    overflow: hidden;
    margin: 32px 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π */
.quick-map-container {
    position: relative;
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.field-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.stat-item {
    background: rgba(23, 42, 69, 0.6);
    padding: 15px;
    border-radius: var(--radius-md);
    text-align: center;
    border: 1px solid rgba(100, 255, 218, 0.1);
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--emerald);
    display: block;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--light-slate);
    margin-top: 5px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π */
.map-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.map-controls .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.form-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid rgba(100, 255, 218, 0.2);
    padding-bottom: 15px;
}

.form-tab {
    padding: 12px 24px;
    background: rgba(23, 42, 69, 0.6);
    border: 1px solid rgba(100, 255, 218, 0.1);
    border-radius: var(--radius-md);
    color: var(--light-slate);
    cursor: pointer;
    transition: all 0.3s var(--ease-smooth);
}

.form-tab.active {
    background: var(--gradient-emerald);
    color: var(--deep-navy);
    border-color: var(--emerald);
}

.form-tab:hover:not(.active) {
    background: rgba(100, 255, 218, 0.1);
    border-color: rgba(100, 255, 218, 0.3);
}

.form-content {
    display: none;
}

.form-content.active {
    display: block;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) {
    .field-stats {
        grid-template-columns: 1fr 1fr;
    }

    .map-controls {
        flex-direction: column;
    }

    .map-controls .btn {
        margin-bottom: 10px;
        justify-content: center;
    }

    .field-details {
        grid-template-columns: 1fr;
    }

    .form-tabs {
        flex-direction: column;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(100, 255, 218, 0.3);
    border-radius: 50%;
    border-top-color: var(--emerald);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<!-- Flash —Å–æ–æ–±—â–µ–Ω–∏—è -->
{% if flash_message %}
<div class="notification notification-success">
    <span>{{ flash_message }}</span>
    <button onclick="this.parentElement.remove()">√ó</button>
</div>
{% endif %}

{% if flash_error %}
<div class="notification notification-error">
    <span>{{ flash_error }}</span>
    <button onclick="this.parentElement.remove()">√ó</button>
</div>
{% endif %}

<!-- –ì–µ—Ä–æ–π —Å–µ–∫—Ü–∏—è -->
<section class="hero-section">
    <div class="container">
        <h1 class="hero-title">üó∫Ô∏è –ì–µ–æ-—É—á–µ—Ç –ø–æ–ª–µ–π</h1>
        <p class="hero-subtitle">
            –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–µ–º–µ–ª—å —Å —Ç–æ—á–Ω—ã–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –≥—Ä–∞–Ω–∏—Ü –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—á–µ—Ç–æ–º –ø–ª–æ—â–∞–¥–µ–π
        </p>
    </div>
</section>

<!-- –û–±–∑–æ—Ä –≤—Å–µ—Ö –ø–æ–ª–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ -->
<section style="margin-bottom: 60px;">
    <div class="container">
        <h2 class="section-title">–û–±–∑–æ—Ä –≤—Å–µ—Ö –ø–æ–ª–µ–π</h2>
        <div id="overviewMap" class="overview-map"></div>
    </div>
</section>

<!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è -->
<section style="margin-bottom: 60px;">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom: 8px;">üéØ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ</h2>
            <p style="color: var(--light-slate); margin-bottom: 32px;">
                –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è: —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
            </p>

            <!-- –í–∫–ª–∞–¥–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ -->
            <div class="form-tabs">
                <div class="form-tab active" data-tab="map">üó∫Ô∏è –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</div>
                <div class="form-tab" data-tab="manual">üìù –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</div>
            </div>

            <!-- –§–æ—Ä–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ -->
            <div id="mapForm" class="form-content active">
                <div class="map-controls">
                    <button type="button" id="drawPolygonBtn" class="btn btn-primary">
                        üñäÔ∏è –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
                    </button>
                    <button type="button" id="clearPolygonBtn" class="btn btn-secondary" disabled>
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                    <button type="button" id="locateMeBtn" class="btn btn-secondary">
                        üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                    </button>
                </div>

                <div class="form-group">
                    <label for="quickFieldName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è *</label>
                    <input type="text" id="quickFieldName" class="form-input"
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–ª–µ 1" maxlength="100" required>
                </div>

                <div id="quickFieldInfo" class="card" style="display: none; background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3);">
                    <h4 style="margin-bottom: 16px;">üìê –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–µ</h4>
                    <div class="field-stats">
                        <div class="stat-item">
                            <span class="stat-value" id="quickFieldArea">0</span>
                            <span class="stat-label">–ü–ª–æ—â–∞–¥—å (–≥–∞)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="quickFieldPerimeter">0</span>
                            <span class="stat-label">–ü–µ—Ä–∏–º–µ—Ç—Ä (–∫–º)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="quickFieldPoints">0</span>
                            <span class="stat-label">–¢–æ—á–µ–∫ –≥—Ä–∞–Ω–∏—Ü—ã</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="quickFieldCenter">-</span>
                            <span class="stat-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞</span>
                        </div>
                    </div>
                </div>

                <div class="map-container">
                    <div id="quickMap" style="height: 100%;"></div>
                </div>

                <div class="field-actions" style="margin-top: 24px;">
                    <button type="button" id="saveQuickFieldBtn" class="btn btn-primary" disabled>
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–µ
                    </button>
                    <button type="button" id="cancelQuickFieldBtn" class="btn btn-secondary">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ -->
            <div id="manualForm" class="form-content">
                <form method="post" action="/fields" id="manualFieldForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="manualFieldName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è *</label>
                            <input type="text" id="manualFieldName" name="name" required
                            class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–ª–µ">
                        </div>
                        <div class="form-group">
                            <label for="manualFieldArea" class="form-label">–ü–ª–æ—â–∞–¥—å (–≥–∞) *</label>
                            <input type="number" id="manualFieldArea" name="area" step="0.01"
                            min="0.01" required class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5.5">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="manualFieldLat" class="form-label">–®–∏—Ä–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞</label>
                            <input type="number" id="manualFieldLat" name="latitude" step="0.000001"
                            class="form-input" placeholder="55.7558">
                        </div>
                        <div class="form-group">
                            <label for="manualFieldLng" class="form-label">–î–æ–ª–≥–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞</label>
                            <input type="number" id="manualFieldLng" name="longitude" step="0.000001"
                            class="form-input" placeholder="37.6173">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="manualFieldSoil" class="form-label">–¢–∏–ø –ø–æ—á–≤—ã</label>
                        <select id="manualFieldSoil" name="soil_type" class="form-select">
                            <option value="—Å—É–≥–ª–∏–Ω–æ–∫">–°—É–≥–ª–∏–Ω–æ–∫</option>
                            <option value="—á–µ—Ä–Ω–æ–∑–µ–º">–ß–µ—Ä–Ω–æ–∑–µ–º</option>
                            <option value="–ø–µ—Å—á–∞–Ω–∞—è">–ü–µ—Å—á–∞–Ω–∞—è</option>
                            <option value="–≥–ª–∏–Ω–∏—Å—Ç–∞—è">–ì–ª–∏–Ω–∏—Å—Ç–∞—è</option>
                            <option value="—Ç–æ—Ä—Ñ—è–Ω–∞—è">–¢–æ—Ä—Ñ—è–Ω–∞—è</option>
                        </select>
                    </div>

                    <div class="field-actions" style="margin-top: 24px;">
                        <button type="submit" class="btn btn-primary">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–µ
                        </button>
                        <button type="button" id="cancelManualBtn" class="btn btn-secondary">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π -->
<section>
    <div class="container">
        <h2 class="section-title">–ú–æ–∏ –ø–æ–ª—è ({{ fields|length }})</h2>

        {% if fields %}
        <div class="field-grid">
            {% for field in fields %}
            <div class="field-card">
                <div class="field-header">
                    <h3 class="field-name">{{ field.name }}</h3>
                    {% if field.area %}
                    <span class="field-area">{{ "%.2f"|format(field.area) }} –≥–∞</span>
                    {% endif %}
                </div>

                <div class="field-details">
                    <div class="field-detail">
                        <span class="detail-label">ID –ø–æ–ª—è</span>
                        <span class="detail-value">#{{ field.id }}</span>
                    </div>
                    <div class="field-detail">
                        <span class="detail-label">–î–æ–±–∞–≤–ª–µ–Ω–æ</span>
                        <span class="detail-value">{{ field.created_at[:10] }}</span>
                    </div>
                    {% if field.polygon_coords %}
                    <div class="field-detail">
                        <span class="detail-label">–ì—Ä–∞–Ω–∏—Ü—ã</span>
                        <span class="detail-value">üìê –∑–∞–¥–∞–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ</span>
                    </div>
                    {% endif %}
                    {% if field.center_lat and field.center_lng %}
                    <div class="field-detail">
                        <span class="detail-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</span>
                        <span class="detail-value">
                            {{ "%.4f"|format(field.center_lat) }}, {{ "%.4f"|format(field.center_lng) }}
                        </span>
                    </div>
                    {% endif %}
                    {% if field.soil_type %}
                    <div class="field-detail">
                        <span class="detail-label">–¢–∏–ø –ø–æ—á–≤—ã</span>
                        <span class="detail-value">{{ field.soil_type }}</span>
                    </div>
                    {% endif %}
                </div>

                <div class="field-actions">
                    <a href="/fields/{{ field.id }}" class="btn btn-primary" style="flex: 1;">
                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                    </a>
                    <button onclick="exportField({{ field.id }})" class="btn btn-secondary" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ GeoJSON">
                        üì§
                    </button>
                    <a href="/fields/delete/{{ field.id }}" class="btn"
                       style="background: rgba(239, 68, 68, 0.2); color: #ef4444;"
                       onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ \"{{ field.name }}\"?')">
                        üóëÔ∏è
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üåæ</div>
            <h3 style="color: var(--light-slate); margin-bottom: 16px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª–µ–π</h3>
            <p style="color: var(--light-slate); margin-bottom: 32px;">
                –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ
            </p>
        </div>
        {% endif %}
    </div>
</section>

<script>
// –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–µ–π –¥–ª—è –∫–∞—Ä—Ç—ã –æ–±–∑–æ—Ä–∞
window.fieldsData = {{ fields|tojson }};

// –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–ª—è
function exportField(fieldId) {
    fetch(`/api/fields/${fieldId}/geojson`)
    .then(response => response.json())
    .then(data => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `field_${fieldId}.geojson`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();

        showNotification('–ü–æ–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ GeoJSON', 'success');
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –ø–æ–ª—è', 'error');
    });
}

// ============================================================================
// –ö–æ–¥ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞–º–∏
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
    const tabs = document.querySelectorAll('.form-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');

            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
            tabs.forEach(t => t.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ
            this.classList.add('active');

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã
            document.querySelectorAll('.form-content').forEach(form => {
                form.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ñ–æ—Ä–º—É
            document.getElementById(tabId + 'Form').classList.add('active');
        });
    });

    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –¥–ª—è —Ä—É—á–Ω–æ–π —Ñ–æ—Ä–º—ã
    document.getElementById('cancelManualBtn').addEventListener('click', function() {
        document.getElementById('manualFieldForm').reset();
    });
});

// ============================================================================
// –ö–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è –Ω–∞ –∫–∞—Ä—Ç–µ
// ============================================================================

let quickMap;
let quickDrawnItems;
let isDrawing = false;
let currentPolygon = null;
let polygonPoints = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
function initQuickMap() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');

    try {
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –†–æ—Å—Å–∏–∏
        quickMap = L.map('quickMap').setView([55.7558, 37.6173], 5);

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(quickMap);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ–π –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        quickDrawnItems = new L.FeatureGroup();
        quickMap.addLayer(quickDrawnItems);

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å –º–∞—Å—à—Ç–∞–±–∞
        L.control.scale({ imperial: false, metric: true }).addTo(quickMap);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('drawPolygonBtn').addEventListener('click', startDrawing);
        document.getElementById('clearPolygonBtn').addEventListener('click', clearDrawing);
        document.getElementById('locateMeBtn').addEventListener('click', locateUser);
        document.getElementById('saveQuickFieldBtn').addEventListener('click', saveQuickField);
        document.getElementById('cancelQuickFieldBtn').addEventListener('click', resetQuickForm);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª—è
        document.getElementById('quickFieldName').addEventListener('input', function() {
            const hasName = this.value.trim().length > 0;
            const hasPolygon = polygonPoints && polygonPoints.length >= 3;
            document.getElementById('saveQuickFieldBtn').disabled = !(hasName && hasPolygon);
        });

        // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        quickMap.on('dblclick', function(e) {
            if (isDrawing && polygonPoints && polygonPoints.length >= 3) {
                finishDrawing();
            }
        });

        console.log('–ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã', 'error');
    }
}

// –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞
function startDrawing() {
    if (isDrawing) return;

    isDrawing = true;
    const drawBtn = document.getElementById('drawPolygonBtn');
    drawBtn.disabled = true;
    drawBtn.textContent = 'üñäÔ∏è –†–∏—Å—É–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ...';
    drawBtn.classList.remove('btn-primary');
    drawBtn.classList.add('btn-secondary');

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    quickMap.on('click', addPointToPolygon);

    showNotification('–ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏ –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—è. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º.', 'info');
}

// –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –∫ –ø–æ–ª–∏–≥–æ–Ω—É
function addPointToPolygon(e) {
    if (!isDrawing) return;

    const latlng = e.latlng;

    // –ï—Å–ª–∏ –ø–æ–ª–∏–≥–æ–Ω–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
    if (!currentPolygon) {
        currentPolygon = L.polygon([], {
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.3,
            weight: 3
        }).addTo(quickDrawnItems);

        polygonPoints = [];
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É
    polygonPoints.push([latlng.lat, latlng.lng]);
    currentPolygon.setLatLngs([polygonPoints]);

    updateQuickFieldInfo();
}

// –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
function finishDrawing() {
    if (!isDrawing || !currentPolygon) return;

    isDrawing = false;
    quickMap.off('click', addPointToPolygon);

    const drawBtn = document.getElementById('drawPolygonBtn');
    drawBtn.disabled = false;
    drawBtn.textContent = 'üñäÔ∏è –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ';
    drawBtn.classList.remove('btn-secondary');
    drawBtn.classList.add('btn-primary');

    document.getElementById('clearPolygonBtn').disabled = false;

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ
    const fieldName = document.getElementById('quickFieldName').value.trim();
    if (fieldName && polygonPoints.length >= 3) {
        document.getElementById('saveQuickFieldBtn').disabled = false;
    }

    showNotification('–ü–æ–ª–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–æ! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ.', 'success');
}

// –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª–µ
function updateQuickFieldInfo() {
    if (!currentPolygon || polygonPoints.length < 3) {
        document.getElementById('quickFieldInfo').style.display = 'none';
        return;
    }

    // –í—ã—á–∏—Å–ª—è–µ–º –ø–ª–æ—â–∞–¥—å
    const area = L.GeometryUtil.geodesicArea(currentPolygon.getLatLngs()[0]);
    const areaHectares = (area / 10000).toFixed(2);

    // –í—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–∏–º–µ—Ç—Ä
    const perimeter = calculatePerimeter(polygonPoints);

    // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä
    const center = calculateCenter(polygonPoints);

    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    document.getElementById('quickFieldArea').textContent = areaHectares;
    document.getElementById('quickFieldPerimeter').textContent = perimeter;
    document.getElementById('quickFieldPoints').textContent = polygonPoints.length;
    document.getElementById('quickFieldCenter').textContent =
        `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;

    document.getElementById('quickFieldInfo').style.display = 'block';
}

// –í—ã—á–∏—Å–ª–∏—Ç—å –ø–µ—Ä–∏–º–µ—Ç—Ä
function calculatePerimeter(points) {
    let perimeter = 0;
    for (let i = 0; i < points.length; i++) {
        const p1 = points[i];
        const p2 = points[(i + 1) % points.length];
        perimeter += calculateDistance(p1[0], p1[1], p2[0], p2[1]);
    }
    return (perimeter / 1000).toFixed(2); // –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö
}

// –í—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000; // —Ä–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// –í—ã—á–∏—Å–ª–∏—Ç—å —Ü–µ–Ω—Ç—Ä –ø–æ–ª–∏–≥–æ–Ω–∞
function calculateCenter(points) {
    const lats = points.map(p => p[0]);
    const lngs = points.map(p => p[1]);

    return {
        lat: lats.reduce((a, b) => a + b) / lats.length,
        lng: lngs.reduce((a, b) => a + b) / lngs.length
    };
}

// –û—á–∏—Å—Ç–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫
function clearDrawing() {
    if (currentPolygon) {
        quickDrawnItems.removeLayer(currentPolygon);
        currentPolygon = null;
        polygonPoints = [];
    }

    isDrawing = false;
    quickMap.off('click', addPointToPolygon);

    const drawBtn = document.getElementById('drawPolygonBtn');
    drawBtn.disabled = false;
    drawBtn.textContent = 'üñäÔ∏è –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ';
    drawBtn.classList.remove('btn-secondary');
    drawBtn.classList.add('btn-primary');

    document.getElementById('clearPolygonBtn').disabled = true;
    document.getElementById('saveQuickFieldBtn').disabled = true;
    document.getElementById('quickFieldInfo').style.display = 'none';

    showNotification('–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ', 'info');
}

// –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function locateUser() {
    if (!navigator.geolocation) {
        showNotification('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
        return;
    }

    showNotification('–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...', 'info');

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            quickMap.setView([lat, lng], 13);

            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
            L.marker([lat, lng])
                .addTo(quickMap)
                .bindPopup('–í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ')
                .openPopup();

            showNotification('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ!', 'success');
        },
        (error) => {
            let message = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                    break;
                case error.TIMEOUT:
                    message = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ';
                    break;
            }
            showNotification(message, 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–µ
async function saveQuickField() {
    const fieldName = document.getElementById('quickFieldName').value.trim();

    if (!fieldName) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è', 'error');
        return;
    }

    if (!polygonPoints || polygonPoints.length < 3) {
        showNotification('–ù–∞—Ä–∏—Å—É–π—Ç–µ –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—è –Ω–∞ –∫–∞—Ä—Ç–µ', 'error');
        return;
    }

    try {
        const area = parseFloat(document.getElementById('quickFieldArea').textContent);
        const center = calculateCenter(polygonPoints);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const saveBtn = document.getElementById('saveQuickFieldBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="loading"></div> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const formData = new FormData();
        formData.append('name', fieldName);
        formData.append('area', area);
        formData.append('latitude', center.lat);
        formData.append('longitude', center.lng);
        formData.append('polygon_coords', JSON.stringify(polygonPoints));
        formData.append('soil_type', '—Å—É–≥–ª–∏–Ω–æ–∫'); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é

        const response = await fetch('/fields', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            showNotification(`–ü–æ–ª–µ "${fieldName}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!`, 'success');
            resetQuickForm();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π
            setTimeout(() => {
                window.location.reload();
            }, 1500);

        } else {
            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—è:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—è', 'error');

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        const saveBtn = document.getElementById('saveQuickFieldBtn');
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–µ';
    }
}

// –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É
function resetQuickForm() {
    document.getElementById('quickFieldName').value = '';
    clearDrawing();
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => {
        if (notification.parentElement) {
            notification.remove();
        }
    });

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">√ó</button>
    `;
    document.body.appendChild(notification);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
    if (document.getElementById('quickMap')) {
        setTimeout(() => initQuickMap(), 500);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –æ–±–∑–æ—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (document.getElementById('overviewMap')) {
        const fieldsData = window.fieldsData || [];
        setTimeout(() => initOverviewMap(fieldsData), 500);
    }
});
</script>
{% endblock %}