{% extends "base.html" %}

{% block title %}–ì–µ–æ-—É—á–µ—Ç –ø–æ–ª–µ–π - AgroPlan{% endblock %}

{% block extra_css %}
<style>
.map-container {
    height: 500px;
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-medium);
    margin: 20px 0;
}

.field-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 24px;
    margin: 32px 0;
}

.field-card {
    background: rgba(23, 42, 69, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(100, 255, 218, 0.2);
    border-radius: var(--radius-xl);
    padding: 24px;
    transition: all 0.3s var(--ease-smooth);
}

.field-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-luxury);
    border-color: rgba(100, 255, 218, 0.4);
}

.field-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.field-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--white);
    margin: 0;
}

.field-area {
    background: var(--gradient-emerald);
    color: var(--deep-navy);
    padding: 4px 12px;
    border-radius: var(--radius-full);
    font-size: 0.9rem;
    font-weight: 600;
}

.field-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
}

.field-detail {
    display: flex;
    flex-direction: column;
}

.detail-label {
    font-size: 0.8rem;
    color: var(--light-slate);
    margin-bottom: 4px;
}

.detail-value {
    font-size: 0.9rem;
    color: var(--white);
    font-weight: 500;
}

.field-actions {
    display: flex;
    gap: 8px;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--gradient-emerald);
    color: var(--deep-navy);
    padding: 16px 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-large);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideInRight 0.3s var(--ease-out);
}

.notification-error {
    background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
    color: white;
}

.notification button {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π */
.quick-map-container {
    position: relative;
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.field-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.stat-item {
    background: rgba(23, 42, 69, 0.6);
    padding: 15px;
    border-radius: var(--radius-md);
    text-align: center;
    border: 1px solid rgba(100, 255, 218, 0.1);
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--emerald);
    display: block;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--light-slate);
    margin-top: 5px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π */
.map-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.map-controls .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.form-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid rgba(100, 255, 218, 0.2);
    padding-bottom: 15px;
}

.form-tab {
    padding: 12px 24px;
    background: rgba(23, 42, 69, 0.6);
    border: 1px solid rgba(100, 255, 218, 0.1);
    border-radius: var(--radius-md);
    color: var(--light-slate);
    cursor: pointer;
    transition: all 0.3s var(--ease-smooth);
}

.form-tab.active {
    background: var(--gradient-emerald);
    color: var(--deep-navy);
    border-color: var(--emerald);
}

.form-tab:hover:not(.active) {
    background: rgba(100, 255, 218, 0.1);
    border-color: rgba(100, 255, 218, 0.3);
}

.form-content {
    display: none;
}

.form-content.active {
    display: block;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) {
    .field-stats {
        grid-template-columns: 1fr 1fr;
    }

    .map-controls {
        flex-direction: column;
    }

    .map-controls .btn {
        margin-bottom: 10px;
        justify-content: center;
    }

    .field-details {
        grid-template-columns: 1fr;
    }

    .form-tabs {
        flex-direction: column;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(100, 255, 218, 0.3);
    border-radius: 50%;
    border-top-color: var(--emerald);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.soil-type-selector {
    margin: 20px 0;
}

.soil-preview {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 8px;
    vertical-align: middle;
}

.soil-suglink { background: #8B4513; }
.soil-chernozem { background: #2F1B0C; }
.soil-sandy { background: #F4A460; }
.soil-clay { background: #B8860B; }
.soil-peat { background: #5D4037; }

/* –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã */
.hidden-fields {
    display: none;
}
</style>
{% endblock %}

{% block content %}
<!-- Flash —Å–æ–æ–±—â–µ–Ω–∏—è -->
{% if flash_message %}
<div class="notification notification-success">
    <span>{{ flash_message }}</span>
    <button onclick="this.parentElement.remove()">√ó</button>
</div>
{% endif %}

{% if flash_error %}
<div class="notification notification-error">
    <span>{{ flash_error }}</span>
    <button onclick="this.parentElement.remove()">√ó</button>
</div>
{% endif %}

<!-- –ì–µ—Ä–æ–π —Å–µ–∫—Ü–∏—è -->
<section class="hero-section">
    <div class="container">
        <h1 class="hero-title">üó∫Ô∏è –ì–µ–æ-—É—á–µ—Ç –ø–æ–ª–µ–π</h1>
        <p class="hero-subtitle">
            –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–µ–º–µ–ª—å —Å —Ç–æ—á–Ω—ã–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –≥—Ä–∞–Ω–∏—Ü –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—á–µ—Ç–æ–º –ø–ª–æ—â–∞–¥–µ–π
        </p>
    </div>
</section>

<!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è -->
<section style="margin-bottom: 60px;">
    <div class="container">
        <div class="card">
            <h2 style="margin-bottom: 8px;">üéØ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ</h2>
            <p style="color: var(--light-slate); margin-bottom: 32px;">
                –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è: —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
            </p>

            <!-- –í–∫–ª–∞–¥–∫–∏ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ -->
            <div class="form-tabs">
                <div class="form-tab active" data-tab="map">üó∫Ô∏è –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</div>
                <div class="form-tab" data-tab="manual">üìù –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</div>
            </div>

            <!-- –§–æ—Ä–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ -->
            <div id="mapForm" class="form-content active">
                <form method="post" action="/fields" id="quickFieldForm">
                    <div class="map-controls">
                        <button type="button" id="drawPolygonBtn" class="btn btn-primary">
                            üñäÔ∏è –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
                        </button>
                        <button type="button" id="clearPolygonBtn" class="btn btn-secondary" disabled>
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <button type="button" id="locateMeBtn" class="btn btn-secondary">
                            üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="quickFieldName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è *</label>
                        <input type="text" id="quickFieldName" name="name" class="form-input"
                            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–ª–µ 1" maxlength="100" required>
                    </div>

                    <!-- –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ—á–≤—ã -->
                    <div class="form-group soil-type-selector">
                        <label for="quickFieldSoil" class="form-label">–¢–∏–ø –ø–æ—á–≤—ã</label>
                        <select id="quickFieldSoil" name="soil_type" class="form-select">
                            <option value="—Å—É–≥–ª–∏–Ω–æ–∫">–°—É–≥–ª–∏–Ω–æ–∫</option>
                            <option value="—á–µ—Ä–Ω–æ–∑–µ–º">–ß–µ—Ä–Ω–æ–∑–µ–º</option>
                            <option value="–ø–µ—Å—á–∞–Ω–∞—è">–ü–µ—Å—á–∞–Ω–∞—è</option>
                            <option value="–≥–ª–∏–Ω–∏—Å—Ç–∞—è">–ì–ª–∏–Ω–∏—Å—Ç–∞—è</option>
                            <option value="—Ç–æ—Ä—Ñ—è–Ω–∞—è">–¢–æ—Ä—Ñ—è–Ω–∞—è</option>
                        </select>
                    </div>

                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
                    <div class="hidden-fields">
                        <input type="hidden" id="quickFieldAreaInput" name="area">
                        <input type="hidden" id="quickFieldCenterLatInput" name="latitude">
                        <input type="hidden" id="quickFieldCenterLngInput" name="longitude">
                        <input type="hidden" id="quickFieldPolygonCoordsInput" name="polygon_coords">
                    </div>

                    <div id="quickFieldInfo" class="card" style="display: none; background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3);">
                        <h4 style="margin-bottom: 16px;">üìê –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–µ</h4>
                        <div class="field-stats">
                            <div class="stat-item">
                                <span class="stat-value" id="quickFieldArea">0</span>
                                <span class="stat-label">–ü–ª–æ—â–∞–¥—å (–≥–∞)</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="quickFieldCenterLat">-</span>
                                <span class="stat-label">–®–∏—Ä–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="quickFieldCenterLng">-</span>
                                <span class="stat-label">–î–æ–ª–≥–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞</span>
                            </div>
                        </div>
                    </div>

                    <div class="map-container">
                        <div id="quickMap" style="height: 100%;"></div>
                    </div>

                    <div class="field-actions" style="margin-top: 24px;">
                        <button type="submit" id="saveQuickFieldBtn" class="btn btn-primary" disabled>
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–µ
                        </button>
                        <button type="button" id="cancelQuickFieldBtn" class="btn btn-secondary">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            </div>

            <!-- –§–æ—Ä–º–∞ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ -->
            <div id="manualForm" class="form-content">
                <form method="post" action="/fields" id="manualFieldForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="manualFieldName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è *</label>
                            <input type="text" id="manualFieldName" name="name" required
                                class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–ª–µ">
                        </div>
                        <div class="form-group">
                            <label for="manualFieldArea" class="form-label">–ü–ª–æ—â–∞–¥—å (–≥–∞) *</label>
                            <input type="number" id="manualFieldArea" name="area" step="0.01"
                                min="0.01" required class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5.5">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="manualFieldLat" class="form-label">–®–∏—Ä–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞</label>
                            <input type="number" id="manualFieldLat" name="latitude" step="0.000001"
                                class="form-input" placeholder="55.7558">
                        </div>
                        <div class="form-group">
                            <label for="manualFieldLng" class="form-label">–î–æ–ª–≥–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞</label>
                            <input type="number" id="manualFieldLng" name="longitude" step="0.000001"
                                class="form-input" placeholder="37.6173">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="manualFieldSoil" class="form-label">–¢–∏–ø –ø–æ—á–≤—ã</label>
                        <select id="manualFieldSoil" name="soil_type" class="form-select">
                            <option value="—Å—É–≥–ª–∏–Ω–æ–∫">–°—É–≥–ª–∏–Ω–æ–∫</option>
                            <option value="—á–µ—Ä–Ω–æ–∑–µ–º">–ß–µ—Ä–Ω–æ–∑–µ–º</option>
                            <option value="–ø–µ—Å—á–∞–Ω–∞—è">–ü–µ—Å—á–∞–Ω–∞—è</option>
                            <option value="–≥–ª–∏–Ω–∏—Å—Ç–∞—è">–ì–ª–∏–Ω–∏—Å—Ç–∞—è</option>
                            <option value="—Ç–æ—Ä—Ñ—è–Ω–∞—è">–¢–æ—Ä—Ñ—è–Ω–∞—è</option>
                        </select>
                    </div>

                    <div class="field-actions" style="margin-top: 24px;">
                        <button type="submit" class="btn btn-primary">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–µ
                        </button>
                        <button type="button" id="cancelManualBtn" class="btn btn-secondary">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π -->
<section>
    <div class="container">
        <h2 class="section-title">–ú–æ–∏ –ø–æ–ª—è ({{ fields|length }})</h2>

        {% if fields %}
        <div class="field-grid">
            {% for field in fields %}
            <div class="field-card">
                <div class="field-header">
                    <h3 class="field-name">{{ field.name }}</h3>
                    {% if field.area %}
                    <span class="field-area">{{ "%.2f"|format(field.area) }} –≥–∞</span>
                    {% endif %}
                </div>

                <div class="field-details">
                    <div class="field-detail">
                        <span class="detail-label">ID –ø–æ–ª—è</span>
                        <span class="detail-value">#{{ field.id }}</span>
                    </div>
                    <div class="field-detail">
                        <span class="detail-label">–î–æ–±–∞–≤–ª–µ–Ω–æ</span>
                        <span class="detail-value">{{ field.created_at[:10] }}</span>
                    </div>
                    {% if field.polygon_coords %}
                    <div class="field-detail">
                        <span class="detail-label">–ì—Ä–∞–Ω–∏—Ü—ã</span>
                        <span class="detail-value">üìê –∑–∞–¥–∞–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ</span>
                    </div>
                    {% endif %}
                    {% if field.center_lat and field.center_lng %}
                    <div class="field-detail">
                        <span class="detail-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞</span>
                        <span class="detail-value">
                            {{ "%.4f"|format(field.center_lat) }}, {{ "%.4f"|format(field.center_lng) }}
                        </span>
                    </div>
                    {% endif %}
                    {% if field.soil_type %}
                    <div class="field-detail">
                        <span class="detail-label">–¢–∏–ø –ø–æ—á–≤—ã</span>
                        <span class="detail-value">{{ field.soil_type }}</span>
                    </div>
                    {% endif %}
                </div>

                <div class="field-actions">
                    <a href="/fields/{{ field.id }}" class="btn btn-primary" style="flex: 1;">
                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                    </a>
                    <a href="/fields/delete/{{ field.id }}" class="btn"
                        style="background: rgba(239, 68, 68, 0.2); color: #ef4444;"
                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ \"{{ field.name }}\"?')">
                        üóëÔ∏è
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üåæ</div>
            <h3 style="color: var(--light-slate); margin-bottom: 16px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª–µ–π</h3>
            <p style="color: var(--light-slate); margin-bottom: 32px;">
                –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ
            </p>
        </div>
        {% endif %}
    </div>
</section>

<script>
let quickMap;
let currentPolygon = null;
let polygonPoints = [];
let isDrawing = false;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–ª–æ—â–∞–¥–∏ –ø–æ–ª–∏–≥–æ–Ω–∞ –≤ –≥–µ–∫—Ç–∞—Ä–∞—Ö
function calculatePolygonArea(latLngs) {
    if (!latLngs || latLngs.length < 3) return 0;

    let area = 0;
    const earthRadius = 6378137;

    for (let i = 0; i < latLngs.length; i++) {
        const j = (i + 1) % latLngs.length;
        const p1 = latLngs[i];
        const p2 = latLngs[j];

        area += (p2.lng - p1.lng) * Math.PI / 180 *
                Math.cos((p1.lat + p2.lat) * Math.PI / 360) *
                Math.sin(p2.lat * Math.PI / 180 - p1.lat * Math.PI / 180);
    }

    area = earthRadius * earthRadius * Math.abs(area) / 2;
    return area / 10000;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±—ã—Å—Ç—Ä–æ–π –∫–∞—Ä—Ç—ã
function initQuickMap() {
    try {
        quickMap = L.map('quickMap').setView([55.7558, 37.6173], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(quickMap);

        L.control.scale({ imperial: false, metric: true }).addTo(quickMap);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('drawPolygonBtn').addEventListener('click', startDrawing);
        document.getElementById('clearPolygonBtn').addEventListener('click', clearDrawing);
        document.getElementById('cancelQuickFieldBtn').addEventListener('click', resetQuickForm);

        // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        quickMap.on('dblclick', function(e) {
            if (isDrawing && polygonPoints.length >= 3) {
                finishDrawing();
            }
        });

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã', 'error');
    }
}

// –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
function startDrawing() {
    if (isDrawing) return;

    isDrawing = true;
    const drawBtn = document.getElementById('drawPolygonBtn');
    drawBtn.disabled = true;
    drawBtn.textContent = 'üñäÔ∏è –†–∏—Å—É–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ...';

    quickMap.on('click', addPointToPolygon);
    showNotification('–ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º.', 'info');
}

// –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É
function addPointToPolygon(e) {
    if (!isDrawing) return;

    const latlng = e.latlng;

    if (!currentPolygon) {
        currentPolygon = L.polygon([], {
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.3,
            weight: 3
        }).addTo(quickMap);
        polygonPoints = [];
    }

    polygonPoints.push([latlng.lat, latlng.lng]);
    currentPolygon.setLatLngs([polygonPoints]);
    updateQuickFieldInfo();
}

// –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
function finishDrawing() {
    if (!isDrawing || !currentPolygon) return;

    isDrawing = false;
    quickMap.off('click', addPointToPolygon);

    const drawBtn = document.getElementById('drawPolygonBtn');
    drawBtn.disabled = false;
    drawBtn.textContent = 'üñäÔ∏è –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ';

    document.getElementById('clearPolygonBtn').disabled = false;
    updateSaveButtonState();

    showNotification('–ü–æ–ª–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–æ! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ.', 'success');
}

// –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª–µ
function updateQuickFieldInfo() {
    if (!currentPolygon || polygonPoints.length < 3) {
        document.getElementById('quickFieldInfo').style.display = 'none';
        return;
    }

    const latLngs = polygonPoints.map(point => ({ lat: point[0], lng: point[1] }));
    const area = calculatePolygonArea(latLngs);
    const areaHectares = area.toFixed(2);
    const center = calculateCenter(polygonPoints);

    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    document.getElementById('quickFieldArea').textContent = areaHectares;
    document.getElementById('quickFieldCenterLat').textContent = center.lat.toFixed(6);
    document.getElementById('quickFieldCenterLng').textContent = center.lng.toFixed(6);

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
    document.getElementById('quickFieldAreaInput').value = areaHectares;
    document.getElementById('quickFieldCenterLatInput').value = center.lat;
    document.getElementById('quickFieldCenterLngInput').value = center.lng;
    document.getElementById('quickFieldPolygonCoordsInput').value = JSON.stringify(polygonPoints);

    document.getElementById('quickFieldInfo').style.display = 'block';
    updateSaveButtonState();
}

// –í—ã—á–∏—Å–ª–∏—Ç—å —Ü–µ–Ω—Ç—Ä
function calculateCenter(points) {
    const lats = points.map(p => p[0]);
    const lngs = points.map(p => p[1]);

    return {
        lat: lats.reduce((a, b) => a + b) / lats.length,
        lng: lngs.reduce((a, b) => a + b) / lngs.length
    };
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
function updateSaveButtonState() {
    const hasName = document.getElementById('quickFieldName').value.trim().length > 0;
    const hasPolygon = polygonPoints && polygonPoints.length >= 3;
    document.getElementById('saveQuickFieldBtn').disabled = !(hasName && hasPolygon);
}

// –û—á–∏—Å—Ç–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫
function clearDrawing() {
    if (currentPolygon) {
        quickMap.removeLayer(currentPolygon);
        currentPolygon = null;
        polygonPoints = [];
    }

    isDrawing = false;
    quickMap.off('click', addPointToPolygon);

    const drawBtn = document.getElementById('drawPolygonBtn');
    drawBtn.disabled = false;
    drawBtn.textContent = 'üñäÔ∏è –ù–∞—á–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ';

    document.getElementById('clearPolygonBtn').disabled = true;
    document.getElementById('saveQuickFieldBtn').disabled = true;
    document.getElementById('quickFieldInfo').style.display = 'none';

    // –û—á–∏—â–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
    document.getElementById('quickFieldAreaInput').value = '';
    document.getElementById('quickFieldCenterLatInput').value = '';
    document.getElementById('quickFieldCenterLngInput').value = '';
    document.getElementById('quickFieldPolygonCoordsInput').value = '';
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–µ
async function saveQuickField() {
    const fieldName = document.getElementById('quickFieldName').value.trim();
    const soilType = document.getElementById('quickFieldSoil').value;
    const area = document.getElementById('quickFieldAreaInput').value;
    const centerLat = document.getElementById('quickFieldCenterLatInput').value;
    const centerLng = document.getElementById('quickFieldCenterLngInput').value;
    const polygonCoords = document.getElementById('quickFieldPolygonCoordsInput').value;

    if (!fieldName) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è', 'error');
        return;
    }

    if (!polygonCoords) {
        showNotification('–ù–∞—Ä–∏—Å—É–π—Ç–µ –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—è –Ω–∞ –∫–∞—Ä—Ç–µ', 'error');
        return;
    }

    try {
        const saveBtn = document.getElementById('saveQuickFieldBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="loading"></div> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        const formData = new FormData();
        formData.append('name', fieldName);
        formData.append('area', area);
        formData.append('latitude', centerLat);
        formData.append('longitude', centerLng);
        formData.append('polygon_coords', polygonCoords);
        formData.append('soil_type', soilType);

        const response = await fetch('/fields', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            showNotification(`–ü–æ–ª–µ "${fieldName}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!`, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—è:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—è', 'error');

        const saveBtn = document.getElementById('saveQuickFieldBtn');
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–µ';
    }
}

// –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É
function resetQuickForm() {
    document.getElementById('quickFieldName').value = '';
    document.getElementById('quickFieldSoil').value = '—Å—É–≥–ª–∏–Ω–æ–∫';
    clearDrawing();
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => {
        if (notification.parentElement) {
            notification.remove();
        }
    });

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">√ó</button>
    `;
    document.body.appendChild(notification);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
document.addEventListener('DOMContentLoaded', function() {
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
    const tabs = document.querySelectorAll('.form-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');

            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
            tabs.forEach(t => t.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ
            this.classList.add('active');

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã
            document.querySelectorAll('.form-content').forEach(form => {
                form.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ñ–æ—Ä–º—É
            document.getElementById(tabId + 'Form').classList.add('active');
        });
    });

    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –¥–ª—è —Ä—É—á–Ω–æ–π —Ñ–æ—Ä–º—ã
    document.getElementById('cancelManualBtn').addEventListener('click', function() {
        document.getElementById('manualFieldForm').reset();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
    document.getElementById('quickFieldForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveQuickField();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
    if (document.getElementById('quickMap')) {
        setTimeout(() => initQuickMap(), 500);
    }

    document.getElementById('quickFieldName').addEventListener('input', updateSaveButtonState);
});
</script>
{% endblock %}